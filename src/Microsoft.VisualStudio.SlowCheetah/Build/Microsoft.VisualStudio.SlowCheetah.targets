<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.targets
WARNING:  DO NOT MODIFY this file, this file is added to your project automatically
          through the SlowCheetah NuGet package. If you modify this file it may
          get out of sync when you update the package at a later date.
This file contains the main logic for defining transformations on build.
Copyright (C) Microsoft Corporation. All rights reserved.
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <SlowCheetahTaskPath>$(MSBuildThisFileDirectory)..\tools\</SlowCheetahTaskPath>
  </PropertyGroup>

  <!--Main transformation task-->
  <UsingTask TaskName="TransformTask" AssemblyFile="$(SlowCheetahTaskPath)Microsoft.VisualStudio.SlowCheetah.dll"/>

  <ItemDefinitionGroup>
    <!-- Default TransformOnBuild values for file types -->
    <None>
      <TransformOnBuild>false</TransformOnBuild>
    </None>
    <Content>
      <TransformOnBuild>false</TransformOnBuild>
    </Content>
    <Resource>
      <TransformOnBuild>false</TransformOnBuild>
    </Resource>
    <EmbeddedResource>
      <TransformOnBuild>false</TransformOnBuild>
    </EmbeddedResource>
    <ScFilesToTransform>
      <Link />
    </ScFilesToTransform>
  </ItemDefinitionGroup>

  <PropertyGroup>
    <BuildDependsOn>
      ScApplyTransforms;
      $(BuildDependsOn)
    </BuildDependsOn>

    <!-- References .dll.config files in referenced projects -->
    <ScAllowCopyReferencedConfig Condition=" '$(ScAllowCopyReferencedConfig)'=='' ">true</ScAllowCopyReferencedConfig>
    <AllowedReferenceRelatedFileExtensions Condition=" '$(ScAllowCopyReferencedConfig)'=='true' ">
      .dll.config;
      $(AllowedReferenceRelatedFileExtensions)
    </AllowedReferenceRelatedFileExtensions>
  </PropertyGroup>

  <Target Name="ScCollectTransformFiles" BeforeTargets="ScApplyTransforms">

    <Message Text="SlowCheetah: Collecting Transform files" Importance="low"/>

    <ItemGroup>
      <ScFilesToTransform Include="@(None);@(Content);@(Resource);@(EmbeddedResource)"
                         Condition=" '%(TransformOnBuild)' == 'true' " />

      <!--
          Two seperate actions, so if @(ScFilesToTransform) already contains items
          the metadata will be set on them as well.
      -->
      <ScFilesToTransform>
        <SourceFile>%(FullPath)</SourceFile>
        <TransformFile>%(RelativeDir)%(Filename).$(Configuration)%(Extension)</TransformFile>
        <DestinationFile>$(OutDir)%(RelativeDir)%(Filename)%(Extension)</DestinationFile>
        <DestinationFile Condition="'%(Link)' != ''">$(OutDir)%(Link)</DestinationFile>
      </ScFilesToTransform>
    </ItemGroup>

  </Target>

  <Target Name="ScApplyTransforms" AfterTargets="CopyFilesToOutputDirectory">

    <Message Text="SlowCheetah: Applying Transforms" Importance="low"/>

    <!-- Get the directories that must be created -->
    <ItemGroup>
      <_ScDirsToCreate Include="@(ScFilesToTransform->'%(DestinationFile)')" Condition="Exists('%(TransformFile)')"/>
    </ItemGroup>

    <MakeDir Directories="@(_ScDirsToCreate->'%(RelativeDir)')" Condition="!Exists('%(RelativeDir)')" />

    <SlowCheetah.TransformTask Source="@(ScFilesToTransform->'%(SourceFile)')"
                               Transform="%(TransformFile)"
                               Destination="%(DestinationFile)"
                               Condition=" Exists('%(TransformFile)')"/>

  </Target>

  <Target Name="ScCopyTransformFilesToPublishDirectory" DependsOnTargets="ScApplyTransforms" AfterTargets="CopyFilesToPublishDirectory">
    <ItemGroup>
      <_ScPublishItemsToCopy Include="@(ScFilesToTransform->'$(OutDir)%(RelativeDir)%(Filename)%(Extension)')"/>
    </ItemGroup>
    <Copy SourceFiles="@(_ScPublishItemsToCopy)" DestinationFolder="$(PublishDir)" SkipUnchangedFiles="true" />
  </Target>

  <!-- Import native SlowCheetah behaviour -->
  <Import Project="$(MSBuildThisFileDirectory)Microsoft.VisualStudio.SlowCheetah.*.targets" />

</Project>
